name: Deploy GCloud Functions

on:
  push:
    # branches:
    #   - main
    paths:
      - ".gcloud/functions/**"
  workflow_dispatch:
    inputs:
      function:
        description: Select the function you want to deploy.
        required: true
        type: choice
        options:
          - __all__
          - load_data_into_bigquery

env:
  FUNCS_DIR: .gcloud/functions

jobs:
  functions:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ðŸ›« Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 2 # Required to compare diffs
          persist-credentials: true

      - name: List Functions
        id: list
        working-directory: ${{ env.FUNCS_DIR }}
        run: |
          readarray -t func_dirs < <(ls -d1 *)

          functions="$(jq -n -c --args '$ARGS.positional' "${func_dirs[@]}")"
          echo "functions=$functions" >> $GITHUB_OUTPUT

          files_yaml="$(echo "$functions" | jq -c '
            map({(.) : ["${{ env.FUNCS_DIR }}/\(.)/**"]}) | add
          ')"
          echo "files_yaml=$files_yaml" >> $GITHUB_OUTPUT

      - name: ðŸ”Ž Check for File Changes
        id: changed-files
        if: github.event_name == 'push'
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47 (SHA is safer than the version tag!)
        with:
          files_yaml: ${{ steps.list.outputs.files_yaml }}

      - name: ðŸ”Ž Set Matrix
        id: set-matrix
        run: |
          changed_files="${{ toJson(steps.changed-files.outputs) }}"

          declare -A deploy_args=(
            ["load_data_into_bigquery"]="--runtime=python312 --trigger_bucket=LOL" # ${ secrets.LOAD_DATA_INTO_BQ_BUCKET_NAME }}
          )

          matrix='{"include":[]}'
          while IFS= read -r function; do
            echo "$function"
            if (
              ${{ inputs.function == '__all__' }} ||
              [ "${{ inputs.function }}" = "$function" ] ||
              $(echo "$changed_files" | jq "${function}_any_changed")
            ); then
              echo "> Adding \"$function\" to the deploy-matrix."

              matrix="$(echo "$matrix" | jq -c '
                .include += [{
                  "function": "'"$function"'",
                  "deploy_args": "'"${deploy_args["$function"]}"'"
                }]
              ')"
            fi
          done < <(echo "${{ steps.list.outputs.functions }}" | jq -r .[])
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  deploy:
    needs: [functions]
    runs-on: ubuntu-22.04
    strategy:
      matrix: ${{ fromJson(needs.functions.outputs.matrix) }}
    steps:
      - name: ðŸ›« Checkout code
        uses: actions/checkout@v5

      - name: echo
        run: echo "functions deploy ${{ matrix.function }} --region=europe-west2 --source=${{ env.FUNCS_DIR }}/${{ matrix.function }} --entry-point=main ${{ matrix.deploy_args }}"

      # https://docs.cloud.google.com/functions/docs/deploy
      # - name: "ðŸš€ Deploy Function: ${{ matrix.function }}"
      #   uses: ocadotechnology/codeforlife-workspace/.github/actions/gcloud/run@main
      #   with:
      #     args: functions deploy ${{ matrix.function }} --region=europe-west2 --source=${{ env.FUNCS_DIR }}/${{ matrix.function }} --entry-point=main ${{ matrix.deploy_args }}
