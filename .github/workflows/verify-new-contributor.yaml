name: Verify New Contributor

on:
  push:
    branches:
      - new_contributor_validations # TODO: use main
  workflow_dispatch:
    inputs:
      pull-request-number:
        description: "The number of the new contributor's PR."
        required: true

jobs:
  view-pr:
    uses: ocadotechnology/codeforlife-workspace/.github/workflows/view-pull-request.yaml@new_contributor_validations # TODO: use @main
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    with:
      number: ${{ inputs.pull-request-number }}
      outputs: url
      review-state: APPROVED

  # validate-new-contributor:
  #   # needs: [validate-pr-review-state]
  #   uses: ocadotechnology/codeforlife-workspace/.github/workflows/validate-new-contributor.yaml@new_contributor_validations # TODO: use @main
  #   with:
  #     pull-request-number: 54 #${{ inputs.pull-request-number }}

  verify-new-contributor:
    needs: [view-pr] #[validate-new-contributor]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“§ Send Verification Email
        uses: ocadotechnology/codeforlife-workspace/.github/actions/python/send-email@new_contributor_validations # TODO: use @main
        with:
          auth: ${{ secrets.DOTDIGITAL_API_USER_AUTH }}
          to-addresses: '["stefan.kairinos@ocado.com"]' #'["${{ needs.validate-new-contributor.outputs.email-address }}"]'
          campaign-id: 1506387
          personalization-values: '[{"name": "PR_URL", "value": "${{ needs.view-pr.outputs.url }}"}]'
