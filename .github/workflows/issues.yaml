name: Issues

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created, edited]
  schedule:
    - cron: "0 9 * * *" # Every day at 9am UTC.
  workflow_dispatch:
    inputs:
      job:
        description: Select the job you want to run.
        required: true
        type: choice
        options:
          - body
          - inactive
  workflow_call:
    secrets:
      CFL_BOT_GH_TOKEN:
        description: "The CFL-bot's GitHub token. Used to comment."
        required: false

env:
  GH_TOKEN: ${{ secrets.CFL_BOT_GH_TOKEN }}
  EVENT_NAME: ${{ github.event_name }}
  REPO_NAME: ${{ github.event.repository.name }}
  WORKFLOW_REF: ocadotechnology/codeforlife-workspace/.github/workflows/issues.yaml@refs/heads/main

jobs:
  body:
    runs-on: ubuntu-22.04
    if: |
      github.repository_owner_id == 2088731 && (
        (
          github.repository_id == 610732754 && (
            github.event_name == 'schedule' || (
              github.event_name == 'workflow_dispatch' &&
              inputs.job == 'body'
            )
          )
        ) || (
          github.event_name == 'issues' &&
          github.event.action == 'opened' &&
          github.event.issue.user.login != 'cfl-bot' &&
          !contains(github.event.issue.labels.*.name, 'bot ignore')
        )
      )
    env:
      ISSUE_REPO_NAME: "${{ github.event.repository.name }}"
      ISSUE_NUMBER: "${{ github.event.issue.number }}"
    steps:
      - name: üèÉ Download and Run Job Script
        uses: ocadotechnology/codeforlife-workspace/.github/actions/workspace/run-job-script@main
        with:
          args: "${{ github.event.issue.body }}"
          workflow: "${{ env.WORKFLOW_REF }}"
          job: "body"

  prompt:
    runs-on: ubuntu-22.04
    if: |
      github.repository_owner_id == 2088731 &&
      github.event_name == 'issue_comment' &&
      !github.event.issue.pull_request &&
      contains(fromJSON('["created", "edited"]'), github.event.action) &&
      github.event.comment.user.login != 'cfl-bot' &&
      !contains(github.event.issue.labels.*.name, 'bot ignore')
    env:
      # String variables.
      ISSUE_REPO_NAME: "${{ github.event.repository.name }}"
      ISSUE_NUMBER: "${{ github.event.issue.number }}"
      ISSUE_NODE_ID: "${{ github.event.issue.node_id }}"
      ISSUE_ASSIGNEES_LENGTH: "${{ github.event.issue.assignees.length }}"
      USER_NODE_ID: "${{ github.event.comment.user.node_id }}"
      USER_LOGIN: "${{ github.event.comment.user.login }}"
      # Boolean variables.
      ISSUE_IS_OPEN: "${{ github.event.issue.state == 'open' }}"
      ISSUE_HAS_COMMENTER_ASSIGNED: "${{ contains(github.event.issue.assignees.*.id, github.event.comment.user.id) }}"
    steps:
      - name: üèÉ Download and Run Job Script
        uses: ocadotechnology/codeforlife-workspace/.github/actions/workspace/run-job-script@main
        with:
          args: "${{ github.event.comment.body }}"
          workflow: "${{ env.WORKFLOW_REF }}"
          job: "prompt"

  inactive:
    runs-on: ubuntu-22.04
    if: |
      github.repository_owner_id == 2088731 &&
      github.repository_id == 610732754 && (
        github.event_name == 'schedule' || (
          github.event_name == 'workflow_dispatch' &&
          inputs.job == 'inactive'
        )
      )
    env:
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - name: üèÉ Download and Run Job Script
        uses: ocadotechnology/codeforlife-workspace/.github/actions/workspace/run-job-script@main
        with:
          workflow: "${{ env.WORKFLOW_REF }}"
          job: "inactive"
