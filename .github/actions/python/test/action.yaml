name: "Code for Life - Python - Test"
description: "Tests python code written in the CFL workspace."
inputs:
  python-version:
    description: "The python version to set up."
    required: true
    default: "3.8"
  working-directory:
    description: "The current working directory."
    required: true
    default: "."
  source-path:
    description: "The path of the source files."
    required: true
    default: "."
  check-django-migrations:
    description: "Check if there are pending Django migrations."
    required: true
    default: "true"
  pyproject-toml:
    description: "The path to the pyproject.toml file."
    required: true
    default: "pyproject.toml"
runs:
  using: composite
  steps:
    - uses: ocadotechnology/codeforlife-workspace/.github/actions/python/setup-environment@main
      with:
        python-version: ${{ inputs.python-version }}
        working-directory: ${{ inputs.working-directory }}
        install-args: "--dev"

    - name: ðŸ”Ž Check Import Sort
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run isort --settings-file=${{ inputs.pyproject-toml }} --check ${{ inputs.source-path }}

    - name: ðŸ”Ž Check Code Format
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: if ! pipenv run black --config=${{ inputs.pyproject-toml }} --check ${{ inputs.source-path }}; then exit 1; fi

    - name: ðŸ”Ž Check Static Type Hints
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run mypy --config-file=${{ inputs.pyproject-toml }} ${{ inputs.source-path }}

    - name: ðŸ”Ž Check Static Code
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run pylint --rcfile=${{ inputs.pyproject-toml }} ${{ inputs.source-path }}

    - name: ðŸ”Ž Check Django Migrations
      if: inputs.check-django-migrations == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run python manage.py makemigrations --check --dry-run

    - name: ðŸ§ª Test Code Units
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run pytest -n=auto -c=${{ inputs.pyproject-toml }} ${{ inputs.source-path }}

    # TODO: assert code coverage target.
