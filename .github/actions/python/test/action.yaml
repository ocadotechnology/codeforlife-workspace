name: "Code for Life - Python - Test"
description: "Tests python code written in the CFL workspace."
inputs:
  python-version:
    description: "The python version to test against"
    required: true
    default: "3.8"
  working-directory:
    description: "The current working directory."
    required: true
    default: "."
  check-django-migrations:
    description: "Check if there are pending Django migrations."
    required: true
    default: "true"
runs:
  using: composite
  steps:
    - name: ğŸ›« Checkout
      uses: actions/checkout@v3

    - name: ğŸ Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}

    - name: ğŸ›  Install Dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        python -m pip install --upgrade pip
        python -m pip install pipenv
        pipenv install --dev

    - name: ğŸ” Check Code Format
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: if ! pipenv run black --check .; then exit 1; fi

    # TODO: check static type hints with mypy

    # TODO: check linter error with pylint

    - name: ğŸ” Check Django Migrations
      if: inputs.check-django-migrations == "true"
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run python manage.py makemigrations --check --dry-run

    # TODO: assert code coverage target.

    - name: ğŸ§ª Test Code Units
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pipenv run pytest
